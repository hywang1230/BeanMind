# Docker åˆå§‹åŒ–é›†æˆè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

ä¸ºäº†è®© Docker å®¹å™¨é¦–æ¬¡å¯åŠ¨æ—¶èƒ½å¤Ÿè‡ªåŠ¨åˆå§‹åŒ–å¿…è¦çš„æ•°æ®æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†åˆå§‹åŒ–è„šæœ¬é›†æˆåˆ°äº† Docker é•œåƒä¸­ã€‚

## ğŸ¯ è§£å†³çš„é—®é¢˜

åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¿è¡Œä»¥ä¸‹è„šæœ¬æ¥åˆå§‹åŒ–æ•°æ®ï¼š

```bash
# æ‰‹åŠ¨åˆå§‹åŒ–æ•°æ®åº“
python -m backend.infrastructure.persistence.init_db

# æ‰‹åŠ¨åˆå§‹åŒ–è´¦æœ¬æ–‡ä»¶
python -m backend.infrastructure.persistence.beancount.init_ledger
```

è¿™å¯¹äº Docker éƒ¨ç½²æ¥è¯´ä¸å¤Ÿå‹å¥½ã€‚ç°åœ¨ï¼Œè¿™äº›åˆå§‹åŒ–æ­¥éª¤ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶**è‡ªåŠ¨æ‰§è¡Œ**ã€‚

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. å…¥å£è„šæœ¬ (`docker-entrypoint.sh`)

åˆ›å»ºäº†ä¸€ä¸ª Docker å…¥å£è„šæœ¬ï¼Œåœ¨å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```bash
#!/bin/bash
set -e

# 1. æ£€æŸ¥å¹¶åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœ beanmind.db ä¸å­˜åœ¨ï¼‰
if [ ! -f "$DB_FILE" ]; then
    python -m backend.infrastructure.persistence.init_db --db-path "$DB_FILE"
fi

# 2. æ£€æŸ¥å¹¶åˆ›å»ºè´¦æœ¬æ–‡ä»¶ï¼ˆå¦‚æœ main.beancount ä¸å­˜åœ¨ï¼‰
if [ ! -f "$LEDGER_FILE" ]; then
    python -m backend.infrastructure.persistence.beancount.init_ledger --ledger-path "$LEDGER_FILE"
fi

# 3. å¯åŠ¨åº”ç”¨
exec "$@"  # æ‰§è¡Œ CMD ä¸­çš„å‘½ä»¤
```

### 2. Dockerfile ä¿®æ”¹

åœ¨ Dockerfile ä¸­æ·»åŠ äº†ï¼š

```dockerfile
# å¤åˆ¶å…¥å£è„šæœ¬
COPY docker-entrypoint.sh /app/docker-entrypoint.sh

# è®¾ç½®å¯æ‰§è¡Œæƒé™
RUN chmod +x /app/docker-entrypoint.sh

# è®¾ç½® ENTRYPOINT
ENTRYPOINT ["/app/docker-entrypoint.sh"]

# CMD ä¿æŒä¸å˜
CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

## âœ¨ ä½¿ç”¨æ•ˆæœ

### é¦–æ¬¡å¯åŠ¨å®¹å™¨

```bash
docker-compose up -d
```

å®¹å™¨å¯åŠ¨æ—¶ä¼šè¾“å‡ºï¼š

```
==========================================
ğŸš€ BeanMind å®¹å™¨å¯åŠ¨ä¸­...
==========================================

[1/3] æ£€æŸ¥æ•°æ®åº“...
ğŸ“¦ æ•°æ®åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆå§‹åŒ–...
âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ

[2/3] æ£€æŸ¥è´¦æœ¬æ–‡ä»¶...
ğŸ“„ è´¦æœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...
âœ… è´¦æœ¬æ–‡ä»¶åˆ›å»ºå®Œæˆ

[3/3] å¯åŠ¨åº”ç”¨...
==========================================
ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡...
==========================================
```

### å†æ¬¡å¯åŠ¨å®¹å™¨

```bash
docker-compose restart
```

å®¹å™¨ä¼šæ£€æµ‹åˆ°æ•°æ®æ–‡ä»¶å·²å­˜åœ¨ï¼Œç›´æ¥å¯åŠ¨ï¼š

```
==========================================
ğŸš€ BeanMind å®¹å™¨å¯åŠ¨ä¸­...
==========================================

[1/3] æ£€æŸ¥æ•°æ®åº“...
âœ… æ•°æ®åº“å·²å­˜åœ¨: /app/data/beanmind.db

[2/3] æ£€æŸ¥è´¦æœ¬æ–‡ä»¶...
âœ… è´¦æœ¬æ–‡ä»¶å·²å­˜åœ¨: /app/data/ledger/main.beancount

[3/3] å¯åŠ¨åº”ç”¨...
==========================================
ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡...
==========================================
```

## ğŸ“‚ æ•°æ®æŒä¹…åŒ–

é€šè¿‡ `docker-compose.yml` ä¸­çš„ volumes é…ç½®ï¼Œæ•°æ®è¢«æŒä¹…åŒ–åˆ°ä¸»æœºï¼š

```yaml
volumes:
  - ./data:/app/data
  - ./logs:/app/logs
```

è¿™æ„å‘³ç€ï¼š
- âœ… å®¹å™¨é‡å¯åæ•°æ®ä¸ä¼šä¸¢å¤±
- âœ… å¯ä»¥ç›´æ¥åœ¨ä¸»æœºä¸Šå¤‡ä»½ `./data` ç›®å½•
- âœ… å¯ä»¥æ‰‹åŠ¨ç¼–è¾‘è´¦æœ¬æ–‡ä»¶ `./data/ledger/main.beancount`

## ğŸ” ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `docker-entrypoint.sh` | Docker å®¹å™¨å…¥å£è„šæœ¬ |
| `Dockerfile` | Docker é•œåƒæ„å»ºæ–‡ä»¶ |
| `backend/infrastructure/persistence/init_db.py` | æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ |
| `backend/infrastructure/persistence/beancount/init_ledger.py` | è´¦æœ¬åˆå§‹åŒ–è„šæœ¬ |

## ğŸš€ é‡æ–°éƒ¨ç½²

å®Œæˆè¿™äº›ä¿®æ”¹åï¼Œéœ€è¦é‡æ–°æ„å»ºé•œåƒï¼š

```bash
# åœæ­¢ç°æœ‰å®¹å™¨
docker-compose down

# é‡æ–°æ„å»ºé•œåƒ
docker-compose build

# å¯åŠ¨æ–°å®¹å™¨
docker-compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f
```

## ğŸ†š ä¸æœ¬åœ°å¼€å‘çš„åŒºåˆ«

| åœºæ™¯ | åˆå§‹åŒ–æ–¹å¼ |
|------|-----------|
| **æœ¬åœ°å¼€å‘** | è¿è¡Œ `start.sh` è„šæœ¬ |
| **Docker éƒ¨ç½²** | å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ `docker-entrypoint.sh` |

ä¸¤ç§æ–¹å¼éƒ½ä¼šï¼š
1. æ£€æŸ¥å¹¶åˆ›å»ºå¿…è¦çš„æ•°æ®æ–‡ä»¶
2. ç¡®ä¿åº”ç”¨èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨
3. é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼ˆæœ¬åœ°å¼€å‘æ£€æŸ¥æ–‡ä»¶ï¼ŒDocker é€šè¿‡ volumes æŒä¹…åŒ–ï¼‰

## ğŸ’¡ æœ€ä½³å®è·µ

1. **é¦–æ¬¡éƒ¨ç½²å‰å¤‡ä»½**ï¼šå¦‚æœä½ å·²ç»æœ‰æ•°æ®ï¼Œå…ˆå¤‡ä»½ `./data` ç›®å½•
2. **æŸ¥çœ‹åˆå§‹åŒ–æ—¥å¿—**ï¼š`docker-compose logs beanmind` å¯ä»¥çœ‹åˆ°åˆå§‹åŒ–è¿‡ç¨‹
3. **æ‰‹åŠ¨åˆå§‹åŒ–**ï¼šå¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥è¿›å…¥å®¹å™¨æ‰‹åŠ¨æ‰§è¡Œï¼š
   ```bash
   docker exec -it beanmind bash
   python -m backend.infrastructure.persistence.init_db
   ```

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1: æƒé™é”™è¯¯

**ç—‡çŠ¶**ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œæ—¥å¿—æ˜¾ç¤º "Permission denied"

**è§£å†³**ï¼šç¡®ä¿ `docker-entrypoint.sh` æœ‰æ‰§è¡Œæƒé™

```bash
chmod +x docker-entrypoint.sh
docker-compose build --no-cache
```

### é—®é¢˜ 2: æ•°æ®åº“æ–‡ä»¶æŸå

**ç—‡çŠ¶**ï¼šå®¹å™¨å¯åŠ¨ï¼Œä½†è®¿é—® API æŠ¥é”™

**è§£å†³**ï¼šåˆ é™¤æŸåçš„æ•°æ®åº“ï¼Œè®©å®¹å™¨é‡æ–°åˆå§‹åŒ–

```bash
docker-compose down
rm -f ./data/beanmind.db
docker-compose up -d
```

### é—®é¢˜ 3: è´¦æœ¬æ–‡ä»¶æ ¼å¼é”™è¯¯

**ç—‡çŠ¶**ï¼šBeancount è§£æå¤±è´¥

**è§£å†³**ï¼šæ£€æŸ¥è´¦æœ¬æ–‡ä»¶è¯­æ³•

```bash
docker exec -it beanmind bean-check /app/data/ledger/main.beancount
```
