#!/bin/bash
set -e

# BeanMind Docker å®¹å™¨å…¥å£è„šæœ¬
# åŠŸèƒ½ï¼š
# 1. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
# 2. åˆå§‹åŒ–è´¦æœ¬æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
# 3. å¯åŠ¨åº”ç”¨

echo "=========================================="
echo "ğŸš€ BeanMind å®¹å™¨å¯åŠ¨ä¸­..."
echo "=========================================="

# è®¾ç½®ç¯å¢ƒå˜é‡
export PYTHONPATH=/app

# æ•°æ®æ–‡ä»¶è·¯å¾„
DB_FILE="${DATABASE_FILE:-/app/data/beanmind.db}"
LEDGER_FILE="${LEDGER_FILE:-/app/data/ledger/main.beancount}"

# ==================== 1. åˆå§‹åŒ–æ•°æ®åº“ ====================
echo ""
echo "[1/3] æ£€æŸ¥æ•°æ®åº“..."

if [ ! -f "$DB_FILE" ]; then
    echo "ğŸ“¦ æ•°æ®åº“ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆå§‹åŒ–..."
    python -m backend.infrastructure.persistence.init_db --db-path "$DB_FILE"
    echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
else
    echo "âœ… æ•°æ®åº“å·²å­˜åœ¨: $DB_FILE"
fi

# ==================== 2. åˆå§‹åŒ–è´¦æœ¬æ–‡ä»¶ ====================
echo ""
echo "[2/3] æ£€æŸ¥è´¦æœ¬æ–‡ä»¶..."

if [ ! -f "$LEDGER_FILE" ]; then
    echo "ğŸ“„ è´¦æœ¬æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
    python -m backend.infrastructure.persistence.beancount.init_ledger --ledger-path "$LEDGER_FILE"
    echo "âœ… è´¦æœ¬æ–‡ä»¶åˆ›å»ºå®Œæˆ"
else
    echo "âœ… è´¦æœ¬æ–‡ä»¶å·²å­˜åœ¨: $LEDGER_FILE"
fi

# ==================== 3. å¯åŠ¨åº”ç”¨ ====================
echo ""
echo "[3/3] å¯åŠ¨åº”ç”¨..."
echo "=========================================="
echo "ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡..."
echo "=========================================="
echo ""

# æ‰§è¡Œä¼ å…¥çš„å‘½ä»¤ï¼ˆé»˜è®¤ä¸º CMD ä¸­å®šä¹‰çš„ uvicorn å‘½ä»¤ï¼‰
exec "$@"
